<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Безопасный город</title>

    <link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css">
    <link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap-theme.min.css">
    <link rel="stylesheet" href="//cdn.leafletjs.com/leaflet-0.7.2/leaflet.css"/>
    <link rel="stylesheet" href="//api.tiles.mapbox.com/mapbox.js/plugins/leaflet-fullscreen/v0.0.2/leaflet.fullscreen.css" />
    <link rel="stylesheet" href="//api.tiles.mapbox.com/mapbox.js/plugins/leaflet-markercluster/v0.4.0/MarkerCluster.css"/>
    <link rel="stylesheet" href="//api.tiles.mapbox.com/mapbox.js/plugins/leaflet-markercluster/v0.4.0/MarkerCluster.Default.css"/>
    <style>
        body {
            padding: 60px 0 0;
        }

        #map-container {
            width: 100%;
            height: 400px;
        }

        .container .jumbotron {
            margin: 30px 0 0;
            padding-top: 10px;
            padding-bottom: 10px;
        }

        .container h2 {
            margin-top: -30px;
            padding-top: 60px;
        }

        .container h3 {
            padding-top: 20px;
        }

        .footer {
            border-top: 1px solid #E5E5E5;
            color: #777777;
            margin-top: 80px;
            padding-bottom: 40px;
            padding-top: 40px;
            text-align: center;
        }

        .info {
            padding: 6px 8px;
            font: 14px/16px Arial, Helvetica, sans-serif;
            background: white;
            background: rgba(255,255,255,0.8);
            box-shadow: 0 0 15px rgba(0,0,0,0.2);
            border-radius: 5px;
        }
        .info h4 {
            margin: 0 0 5px;
            color: #777;
        }

        .legend {
            text-align: left;
            line-height: 18px;
            color: #555;
        }

        .legend i {
            width: 18px;
            height: 18px;
            float: left;
            margin-right: 8px;
            opacity: 0.7;
        }



        .bar {
          fill: steelblue;
        }

        .bar:hover {
          fill: brown;
        }

        .axis {
          font: 10px sans-serif;
        }

        .axis path,
        .axis line {
          fill: none;
          stroke: #000;
          shape-rendering: crispEdges;
        }

        .x.axis path {
          display: none;
        }
    </style>
</head>
<body data-spy="scroll" data-target=".navbar">
<nav class="navbar navbar-default navbar-inverse navbar-fixed-top" role="navigation">
    <div class="container-fluid">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header">
            <a class="navbar-brand" href="#">Безопасный город</a>
        </div>

        <!-- Collect the nav links, forms, and other content for toggling -->
        <div class="collapse navbar-collapse">
            <ul class="nav navbar-nav">
                <li class="active"><a href="#map">Карта</a></li>
                <li><a href="#graph">Графики</a></li>
                <li><a href="#info">Информация</a></li>
                <li><a href="#data">Данные</a></li>
            </ul>
        </div>
        <!-- /.navbar-collapse -->
    </div>
    <!-- /.container-fluid -->
</nav>

<div class="container">
    <div class="page-header">
        <h1>Безопасный город</h1>
        <p>Статистика чрезвычайных происшествий в Минске</p>
    </div>

    <h2 id="map">Карта</h2>
    <div id="map-container"></div>

    <h2 id="graph">Графики</h2>
    <div id="graph-container"></div>

    <h2 id="info">Общая информация</h2>
    <div id="info-container"></div>

    <h2 id="data">Данные</h2>
    <p>Данные о происшествиях и географических делениях взяты на портале открытых данных
        <a href="http://portal.opendata.by/">opendata.by</a>.</p>
</div>

<footer class="footer">
    <p>Приложение разработано на основе данных суточной сводки Минского городского управления МЧС во ходе третьей
        Лаборатории будущего Hack for Future 3-4 мая 2014 г.</p>
</footer>

<script src="//code.jquery.com/jquery-2.1.1.min.js"></script>
<script src="//netdna.bootstrapcdn.com/bootstrap/3.1.1/js/bootstrap.js"></script>
<script src="//cdn.leafletjs.com/leaflet-0.7.2/leaflet.js"></script>
<script src='//api.tiles.mapbox.com/mapbox.js/plugins/leaflet-fullscreen/v0.0.2/Leaflet.fullscreen.min.js'></script>
<script src="//api.tiles.mapbox.com/mapbox.js/plugins/leaflet-markercluster/v0.4.0/leaflet.markercluster.js"></script>
<script src="http://tbicr.github.io/LeafLetSamples/heatmapjs/QuadTree.js"></script>
<script src="http://tbicr.github.io/LeafLetSamples/heatmapjs/heatmap.js"></script>
<script src="http://tbicr.github.io/LeafLetSamples/heatmapjs/heatmap-leaflet.js"></script>
<script src="http://d3js.org/d3.v3.js"></script>

<script>
    var API_BASE = 'http://odata.by/api/action/datastore/search.json?resource_id=';
    var DATA_URL = API_BASE + '1da37dfe-9665-4dd6-843a-cde0dfccff64&limit=2000';
    var REGIONS_BORDERS_URL = API_BASE + 'f53dfb97-3654-4f8b-bd28-c129c9771944&filters[city]=Минск&fields=cityAdministrativeRegion,geojson';
    var JES_BORDERS_URL = API_BASE + 'd48086fc-ea60-4f48-a89f-be4e1c88395e&limit=200';

    var map = L.map('map-container').setView([53.9022756, 27.5618753], 11);
    L.tileLayer('http://{s}.tile.openstreetmap.com/{z}/{x}/{y}.png', {
        attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>',
        maxZoom: 18
    }).addTo(map);

    L.control.fullscreen().addTo(map);

    var RegionLayer = function (map, subMultiplier, nameField, pointInRegion) {
        var that = this;
        this.multiplier = 1;
        this.subMultiplier = subMultiplier;
        this.data = null;

        var infoControl = L.control();

        infoControl.onAdd = function (map) {
            this._div = L.DomUtil.create('div', 'info');
            this.update();
            return this._div;
        };

        infoControl.update = function (props) {
            this._div.innerHTML = '<h4>Происшествия</h4>' +  (props ?
                '<b>' + props.name + '</b><br />' + props.density + ' вызовов'
                : 'Наведите курсор на район');
        };

        var legendControl = L.control({position: 'bottomright'});

        legendControl.onAdd = function (map) {
            var div = L.DomUtil.create('div', 'info legend'),
                    grades = [0, 1, 2, 5, 10, 20, 50, 100],
                    labels = [],
                    from, to;
            for (var i = 0; i < grades.length; i++) {
                from = grades[i] * that.multiplier * that.subMultiplier;
                to = grades[i + 1] * that.multiplier * that.subMultiplier;
                labels.push('<i style="background:' + getColor(from + 1) + '"></i> ' +
                            from + (to ? '&ndash;' + to : '+'));
            }

            div.innerHTML = labels.join('<br>');
            return div;
        };

        this.layer = L.geoJson(null, {
            style: setStyle,
            onEachFeature: onEachFeature
        });

        this.layer.onAdd = function (map) {
            infoControl.addTo(map);
            legendControl.addTo(map);
            return L.GeoJSON.prototype.onAdd.apply(this, arguments);
        };

        this.layer.onRemove = function (map) {
            infoControl.removeFrom(map);
            legendControl.removeFrom(map);
            return L.GeoJSON.prototype.onRemove.apply(this, arguments);
        };

        function getColor(d) {
            var m = that.multiplier * that.subMultiplier;
            return d > 100 * m ? '#800026' :
                   d >  50 * m ? '#BD0026' :
                   d >  20 * m ? '#E31A1C' :
                   d >  10 * m ? '#FC4E2A' :
                   d >   5 * m ? '#FD8D3C' :
                   d >   2 * m ? '#FEB24C' :
                   d >   1 * m ? '#FED976' :
                                 '#FFEDA0';
        }

        function setStyle(feature) {
            return {
                weight: 2,
                opacity: 1,
                color: 'white',
                dashArray: '3',
                fillOpacity: 0.7,
                fillColor: getColor(feature.properties.density)
            };
        }

        function highlightFeature(e) {
            var layer = e.target;

            layer.setStyle({
                weight: 5,
                color: '#666',
                dashArray: '',
                fillOpacity: 0.7
            });

            if (!L.Browser.ie && !L.Browser.opera) {
                layer.bringToFront();
            }

            infoControl.update(layer.feature.properties);
        }

        function resetHighlight(e) {
            that.layer.resetStyle(e.target);
            infoControl.update();
        }

        function zoomToFeature(e) {
            map.fitBounds(e.target.getBounds());
        }

        function onEachFeature(feature, layer) {
            layer.on({
                mouseover: highlightFeature,
                mouseout: resetHighlight,
                click: zoomToFeature
            });
        }

        this.process = function (data) {
            var features = [];
            var records = that.data.result.records;
            for (var i = 0, li = records.length; i < li; i++) {
                var record = records[i];
                var feature = {
                    type: 'Feature',
                    geometry: JSON.parse(record.geojson),
                    properties: {
                        name: record[nameField],
                        density: 0
                    }
                };
                features.push(feature);
                var rank = (data.result.total).toString().length - 1 - 2;
                that.multiplayer = Math.pow(10, rank >= 1 ? rank : 0);
                var dataRecords = data.result.records;
                for (var k = 0, lk = dataRecords.length; k < lk; k++) {
                    var dataRecord = dataRecords[k];
                    if (pointInRegion(dataRecord, record)) {
                        feature.properties.density++;
                    }
                }

            }
            that.layer.addData({
                'type': 'FeatureCollection',
                'features': features
            });
        }
    };

    var markers = L.markerClusterGroup({maxClusterRadius: 40, disableClusteringAtZoom: 15});
    var heatmap = L.TileLayer.heatMap({
        radius: {
            value: 250,
            absolute: true
        },
        opacity: 0.8,
        gradient: {
            0.45: "rgb(0,0,255)",
            0.55: "rgb(0,255,255)",
            0.65: "rgb(0,255,0)",
            0.95: "yellow",
            1.0: "rgb(255,0,0)"
        }
    });

    var administrative = new RegionLayer(map, 10, 'cityAdministrativeRegion', function (dataRecord, geoRecord) {
        return dataRecord.District + ' район' === geoRecord.cityAdministrativeRegion;
    });

    var jeses = new RegionLayer(map, 1, 'publicService', function (dataRecord, geoRecord) {
        return dataRecord.Jes === geoRecord.publicService;
    });

    var loadedData;

    $.getJSON(DATA_URL, function (data) {
        var records = data.result.records;
        var heatmapCanvasData = [];
        for (var i = 0, l = records.length; i < l; i++) {
            var record = records[i];
            var marker = L.marker([record.Latitude, record.Longitude], {title: record.Date});
            marker.bindPopup(record.Date);
            markers.addLayer(marker);
            heatmapCanvasData.push({lat: record.Latitude, lon: record.Longitude, value: 1});
        }
        heatmap.setData(heatmapCanvasData);
        loadedData = data;
        if (administrative.data) {
            administrative.process(loadedData);
        }
        if (jeses.data) {
            jeses.process(loadedData);
        }
        d3process(records, 'Количество происшествий по месяцам', function (d) {
            return d.Date.slice(0, 7);
        });
        d3process(records, 'Количество происшествий по районам', function (d) {
            return d.District;
        });
        d3process(records, 'Количество происшествий по жесам', function (d) {
            return d.Jes && d.Jes != '0' ? d.Jes : 'неизв.';
        });
        processInfo(data);
    });

    $.getJSON(REGIONS_BORDERS_URL, function (data) {
        administrative.data = data;
        if (loadedData) {
            administrative.process(loadedData);
        }
    });

    $.getJSON(JES_BORDERS_URL, function (data) {
        jeses.data = data;
        if (loadedData) {
            jeses.process(loadedData);
        }
    });

    map.addLayer(markers);

    L.control.layers({
        'Обычная карта': markers,
        'Тепловая карта': heatmap,
        'Административное деление': administrative.layer,
        'Деление по жесам': jeses.layer
    }, null, {collapsed: false}).addTo(map);


    function d3process(data, caption, nest) {
        var container = $('#graph-container');
        container.append('<h3>' + caption + '</h3>');

        var margin = {top: 20, right: 20, bottom: 30, left: 40},
                width = 960 - margin.left - margin.right,
                height = 500 - margin.top - margin.bottom;

        var x = d3.scale.ordinal()
                .rangeRoundBands([0, width], .1);

        var y = d3.scale.linear()
                .range([height, 0]);

        var xAxis = d3.svg.axis()
                .scale(x)
                .orient("bottom");

        var yAxis = d3.svg.axis()
                .scale(y)
                .orient("left");

        var svg = d3.select("#graph-container").append("svg")
                .attr("width", width + margin.left + margin.right)
                .attr("height", height + margin.top + margin.bottom)
                .append("g")
                .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

        var ydata = d3.nest().key(nest).entries(data);

        x.domain(ydata.map(function (d) {
            return d.key;
        }).sort(function (a, b) {
            var numA = parseInt(a);
            var numB = parseInt(b);
            if (!isNaN(a) && !isNaN(b)) {
                a = numA;
                b = numB;
            }
            return a == b ? 0 : a < b ? -1 : 1;
        }));
        y.domain([0, d3.max(ydata, function (d) {
            return d.values.length;
        })]);

        svg.append("g")
                .attr("class", "x axis")
                .attr("transform", "translate(0," + height + ")")
                .call(xAxis);

        svg.append("g")
                .attr("class", "y axis")
                .call(yAxis)
                .append("text")
                .attr("transform", "rotate(-90)")
                .attr("y", 6)
                .attr("dy", ".71em")
                .style("text-anchor", "end")
                .text("Вызовы");

        svg.selectAll(".bar")
                .data(ydata)
                .enter().append("rect")
                .attr("class", "bar")
                .attr("x", function (d) {
                    return x(d.key);
                })
                .attr("width", x.rangeBand())
                .attr("y", function (d) {
                    return y(d.values.length);
                })
                .attr("height", function (d) {
                    return height - y(d.values.length);
                });
    }


    function processInfo (data) {
        var container = $('#info-container');

        container.append('<h3>Общее количество происшествий</h3>');
        container.append('<p>' + data.result.total + '</p>');

        container.append('<h3>Количество происшествий по административным районам города</h3>');
        var html = '<table class="table table-striped table-hover table-condensed">';
        var countPerAdministrative = {};
        for (var i = 0, li = data.result.records.length; i < li; i++) {
            if (countPerAdministrative[data.result.records[i].District] === undefined) {
                countPerAdministrative[data.result.records[i].District] = 0;
            }
            for (var administrative in countPerAdministrative) {
                if (data.result.records[i].District === administrative) {
                    countPerAdministrative[administrative]++;
                }
            }
        }
        var sortedKeys = Object.keys(countPerAdministrative).sort(function (a,b) {
            return countPerAdministrative[b] - countPerAdministrative[a];
        });
        var other = 0;
        for (var i = 0, li = sortedKeys.length; i < li; i++) {
            var key = sortedKeys[i];
            if (i < 20) {
            html += '<tr><td>' + key + '</td><td style="text-align: right">' + countPerAdministrative[key] + '</td></tr>';
            } else {
                other += countPerAdministrative[key];
            }
        }
        if (other) {
            html += '<tr><td><b>Остальные</b></td><td style="text-align: right"><b>' + other + '</b></td></tr>';
        }
        html += '</table>';
        container.append(html);

        container.append('<h3>Количество происшествий по отдельным причинам</h3>');
        var html = '<table class="table table-striped table-hover table-condensed">';
        var countPerCause = {};
        for (var i = 0, li = data.result.records.length; i < li; i++) {
            if (countPerCause[data.result.records[i].Cause] === undefined) {
                countPerCause[data.result.records[i].Cause] = 0;
            }
            for (var cause in countPerCause) {
                if (data.result.records[i].Cause === cause) {
                    countPerCause[cause]++;
                }
            }
        }
        var sortedKeys = Object.keys(countPerCause).sort(function (a,b) {
            return countPerCause[b] - countPerCause[a];
        });
        var other = 0;
        for (var i = 0, li = sortedKeys.length; i < li; i++) {
            var key = sortedKeys[i];
            if (i < 20) {
                html += '<tr><td>' + key + '</td><td style="text-align: right">' + countPerCause[key] + '</td></tr>';
            } else {
                other += countPerCause[key];
            }
        }
        if (other) {
            html += '<tr><td><b>Остальные</b></td><td style="text-align: right"><b>' + other + '</b></td></tr>';
        }
        html += '</table>';
        container.append(html);
    }

</script>
</body>
</html>
